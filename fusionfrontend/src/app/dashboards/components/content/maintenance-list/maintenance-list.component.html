<div>
  <div class="clr-row clr-justify-content-between clr-align-items-center list-header">
    <div class="title">Maintenance Dashboard</div>
    <div class="filter-panel">
      <button (click)="filterpanel.toggle($event)" class="filter-btn">
        <fa-icon [icon]="faFilter" class="fa-fw"></fa-icon>
      </button>
      <button (click)="clearAllFilters(); filterpanel.hide()" *ngIf="activeFilterSet.size > 0"
              class="remove-all-filters-btn">
        <i class="pi pi-times-circle remove-all-filters-btn-icon"></i>
      </button>
    </div>
  </div>

  <p-treeTable [value]="treeData"
               [paginator]="true"
               [alwaysShowPaginator]="true"
               [pageLinks]="5"
               [rowsPerPageOptions]="[5,10,50]"
               [rows]="10" class="list-container">
    <ng-template pTemplate="header">
      <tr>
        <th [style.width.%]="2"></th>
        <th [style.width.%]="4"></th>
        <th (click)="searchpanel.toggle($event)" [style.width.%]="20">Asset
          <fa-icon [icon]="faSearch" class="fa-fw"></fa-icon>
        </th>
        <th [style.width.%]="18">Asset Type</th>
        <th [style.width.%]="20">Manufacturer</th>
        <th [style.width.%]="12">Factory</th>
        <th [style.width.%]="13">Days till Maintenance</th>
        <th [style.width.%]="13">Operating Hours till Maintenance</th>
        <th [style.width.%]="2"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
      <tr [ttRow]="rowNode">
        <td [style.width.%]="2"></td>
        <td [style.width.%]="4">
          <div class="list-item-cell notification-icons" [style.width.%]="3" [ngSwitch]="getMaxOpenAlertPriority(rowNode.node)">
            <clr-icon *ngSwitchCase="OispPriority.LOW"    size="20" shape="info-standard" class="is-solid notification-low"></clr-icon>
            <clr-icon *ngSwitchCase="OispPriority.MEDIUM" size="20" shape="exclamation-circle" class="is-solid notification-medium"></clr-icon>
            <clr-icon *ngSwitchCase="OispPriority.HIGH"   size="20" shape="exclamation-triangle" class="is-solid notification-high"></clr-icon>
          </div>
        </td>
        <td [ngClass]="{'asset-needs-maintenance': isMaintenanceNeededSoon(rowNode.node)}" class="asset-column p-flex-row">
          <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
          <span class="subsystem-grid p-col-" *ngIf="rowNode.parent">
            <span class="upper"></span>
            <span class="lower" [ngClass]="{'last-element': isLastChildElement(rowNode)}"></span>
          </span>
          <span class="p-col">{{rowData.name}}</span>
        </td>
        <td [style.width.%]="18">{{rowData.category}}</td>
        <td [style.width.%]="20">{{rowData.manufacturer}}</td>
        <td [style.width.%]="12">{{rowData.factorySiteName}}</td>
        <td [style.width.%]="13">
          <span class="progressbar-wrapper">
            <app-maintenance-progressbar [asset]="rowData"
                                         [maintenancePercentage]="getMaintenanceDaysPercentage(rowData)"
                                         [maintenanceValue]="getMaintenanceDaysValue(rowData)"
                                         [state]="getMaintenanceState(getMaintenanceDaysValue(rowData), MAINTENANCE_DAYS_LOWER_THRESHOLD, MAINTENANCE_DAYS_UPPER_THRESHOLD)"
            >
            </app-maintenance-progressbar>
            <span class="progressbar-icon" *ngIf="isChildrenMaintenanceNeededSoon(rowNode.node)">
              <fa-icon *ngIf="rowNode.node.expanded" [icon]="faChevronCircleDown" (click)="openNode(rowNode.node)" class="fa-fw"></fa-icon>
              <fa-icon *ngIf="!rowNode.node.expanded" [icon]="faChevronCircleUp" (click)="openNode(rowNode.node)" class="fa-fw"></fa-icon>
            </span>
          </span>
        </td>
        <td [style.width.%]="13">
          <app-maintenance-progressbar [asset]="rowData"
                                       [maintenancePercentage]="getMaintenanceHoursPercentage(rowData)"
                                       [maintenanceValue]="getMaintenanceHoursValue(rowData)"
                                       [state]="getMaintenanceState(getMaintenanceHoursValue(rowData), MAINTENANCE_HOURS_LOWER_THRESHOLD, MAINTENANCE_HOURS_UPPER_THRESHOLD)"
          ></app-maintenance-progressbar>
        </td>
        <td [style.width.%]="2"></td>
      </tr>
    </ng-template>
  </p-treeTable>
</div>

<p-overlayPanel #searchpanel [showCloseIcon]="true" class="assetSearchPanel">
  <ng-template pTemplate>
    <div class="panel-heading">Search</div>
    <span class="p-input-icon-left">
            <fa-icon [icon]="faSearch" class="fa-fw"></fa-icon>
            <input [(ngModel)]="searchText" class="search-input" pInputText placeholder="Name" type="text">
        </span>
    <br>
    <div class="footer">
      <button (click)="searchAssets(); searchpanel.hide()"
              class="if-button button-primary button-modal search-panel-button" type="button">Apply
      </button>
    </div>
  </ng-template>
</p-overlayPanel>

<p-overlayPanel #filterpanel [dismissable]="false" class="dashboardFilterPanel">
  <ng-template pTemplate>
    <div class="panel-heading">Filter</div>
    <div>
      <div *ngFor="let activeFilter of activeFilterSet" class="filter-box">
        <div *ngIf="activeFilter.filterAttribute === assetType">
          <p-dropdown [(ngModel)]="activeFilter.filterAttribute" [options]="filterOptions"
                      optionLabel="label"></p-dropdown>
          <button
            (click)="editFilterPanel.toggle($event); dashboardFilterTypeActive = dashboardFilterModalTypes.assetTypeFilterModal"
            class="open-filterpanel-btn">
            <div class="filter-panel-btn-grid">
              <span
                class="filter-panel-btn-grid-text">{{ selectedAssetTypes.length | i18nPlural: selectedValueMapping }}</span>
              <i class="pi pi-chevron-down filter-panel-btn-grid-icon"></i>
            </div>
          </button>
          <button (click)="clearSingleFilter(activeFilter)" class="remove-filter-btn">
            <i class="pi pi-times remove-filter-btn-icon"></i>
          </button>
        </div>
        <div *ngIf="activeFilter.filterAttribute === manufacturer">
          <p-dropdown [(ngModel)]="activeFilter.filterAttribute" [options]="filterOptions"
                      optionLabel="label"></p-dropdown>
          <button
            (click)="editFilterPanel.toggle($event); dashboardFilterTypeActive = dashboardFilterModalTypes.manufacturerFilterModal"
            class="open-filterpanel-btn">
            <div class="filter-panel-btn-grid">
              <span
                class="filter-panel-btn-grid-text">{{ selectedCompanies.length | i18nPlural: selectedValueMapping }}</span>
              <i class="pi pi-chevron-down filter-panel-btn-grid-icon"></i>
            </div>
          </button>
          <button (click)="clearSingleFilter(activeFilter)" class="remove-filter-btn">
            <i class="pi pi-times remove-filter-btn-icon"></i>
          </button>
        </div>
        <div *ngIf="activeFilter.filterAttribute === factory">
          <p-dropdown [(ngModel)]="activeFilter.filterAttribute" [options]="filterOptions"
                      optionLabel="label"></p-dropdown>
          <button
            (click)="editFilterPanel.toggle($event); dashboardFilterTypeActive = dashboardFilterModalTypes.factoryFilterModal"
            class="open-filterpanel-btn">
            <div class="filter-panel-btn-grid">
              <span
                class="filter-panel-btn-grid-text">{{ selectedFactorySites.length | i18nPlural: selectedValueMapping }}</span>
              <i class="pi pi-chevron-down filter-panel-btn-grid-icon"></i>
            </div>
          </button>
          <button (click)="clearSingleFilter(activeFilter)" class="remove-filter-btn">
            <i class="pi pi-times remove-filter-btn-icon"></i>
          </button>
        </div>
        <div *ngIf="activeFilter.filterAttribute === maintenanceDue">
          <p-dropdown [(ngModel)]="activeFilter.filterAttribute" [options]="filterOptions"
                      optionLabel="label"></p-dropdown>
          <button
            (click)="editFilterPanel.toggle($event); dashboardFilterTypeActive = dashboardFilterModalTypes.maintenanceDueFilterModal"
            class="open-filterpanel-btn">
            <div class="filter-panel-btn-grid">
              <span
                class="filter-panel-btn-grid-text">{{ selectedMaintenanceDue.length | i18nPlural: selectedValueMapping }}</span>
              <i class="pi pi-chevron-down filter-panel-btn-grid-icon"></i>
            </div>
          </button>
          <button (click)="clearSingleFilter(activeFilter)" class="remove-filter-btn">
            <i class="pi pi-times remove-filter-btn-icon"></i>
          </button>
        </div>
      </div>
      <button (click)="addFilter()" *ngIf="activeFilterSet.size < 4" class="add-btn">
        <i class="pi pi-plus add-btn-icon"></i>
        Add filter
      </button>
    </div>
  </ng-template>
</p-overlayPanel>

<p-overlayPanel #editFilterPanel class="editFilterPanel">
  <ng-template pTemplate>
    <div *ngIf="dashboardFilterTypeActive == dashboardFilterModalTypes.assetTypeFilterModal">
      <div class="panel-heading">Select AssetType</div>
      <div *ngFor="let assetType of assetTypes">
        <p-checkbox [(ngModel)]="selectedAssetTypes" [inputId]="assetType.id" [value]="assetType" name="assetTypeValues"
                    value="assetType"></p-checkbox>
        <label [for]="assetType.id" class="potential-filter-item">{{assetType.description}}</label>
      </div>
    </div>
    <div *ngIf="dashboardFilterTypeActive == dashboardFilterModalTypes.manufacturerFilterModal">
      <div class="panel-heading">Select Manufacturer</div>
      <div *ngFor="let company of companies">
        <p-checkbox [(ngModel)]="selectedCompanies" [inputId]="company.id" [value]="company" name="companyValues"
                    value="company"></p-checkbox>
        <label [for]="company.id" class="potential-filter-item">{{company.description}}</label>
      </div>
    </div>
    <div *ngIf="dashboardFilterTypeActive == dashboardFilterModalTypes.factoryFilterModal">
      <div class="panel-heading">Select Factory Site</div>
      <div *ngFor="let factorySite of factorySites">
        <p-checkbox [(ngModel)]="selectedFactorySites" [inputId]="factorySite.id" [value]="factorySite"
                    name="factorySitesValues" value="factorySite"></p-checkbox>
        <label [for]="factorySite.id" class="potential-filter-item">{{factorySite.name}}</label>
      </div>
    </div>
    <div *ngIf="dashboardFilterTypeActive == dashboardFilterModalTypes.maintenanceDueFilterModal">
      <div class="panel-heading">Select Factory Site</div>
      <div>
        <p-checkbox [(ngModel)]="selectedMaintenanceDue" name="maintenanceDueValues"
                    value="{{ maintenanceValues[0] }}"></p-checkbox>
        <label class="potential-filter-item">{{ maintenanceValues[0] }}</label>
      </div>
      <div>
        <p-checkbox [(ngModel)]="selectedMaintenanceDue" name="maintenanceDueValues"
                    value="{{ maintenanceValues[1] }}"></p-checkbox>
        <label class="potential-filter-item">{{ maintenanceValues[1] }}</label>
      </div>
      <div>
        <p-checkbox [(ngModel)]="selectedMaintenanceDue" name="maintenanceDueValues"
                    value="{{ maintenanceValues[2] }}"></p-checkbox>
        <label class="potential-filter-item">{{ maintenanceValues[2] }}</label>
      </div>
    </div>

    <div class="filter-buttons-box">
      <button (click)="clearSelectFilterValues(); filterAssets();"
              class="if-button button-secondary button-modal clear-filter-btn">
        Clear all
        <i class="pi pi-times btn-icon"></i>
      </button>
      <button (click)="filterAssets(); editFilterPanel.hide()"
              class="if-button button-primary button-modal select-filter-btn">
        Select
      </button>
    </div>
  </ng-template>
</p-overlayPanel>
